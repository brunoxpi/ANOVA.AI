<div class="p-8 h-full flex flex-col">
  <!-- Header -->
  <div class="flex-shrink-0 flex justify-between items-center mb-6">
    <div class="flex items-center gap-4">
      <a routerLink="/allocations" class="p-2 rounded-full hover:bg-secondary transition-colors">
         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
      </a>
      <div>
        <h2 class="text-3xl font-bold text-foreground">Criar Nova Ordem</h2>
        <p class="text-label mt-1">Utilize o Copilot para montar uma cesta de investimentos para o seu cliente.</p>
      </div>
    </div>
  </div>
  
  @if (!creationPath()) {
    <div class="flex-grow flex flex-col items-center justify-center text-center">
        <h3 class="text-2xl font-bold text-foreground mb-2">Como você gostaria de começar?</h3>
        <p class="text-label mb-8">Escolha um caminho para iniciar a criação da ordem de investimento.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl w-full">
            <!-- Card 1: Proposta Guiada por IA -->
            <div (click)="setCreationPath('guided')" class="group bg-secondary-light p-8 rounded-lg border border-secondary text-center cursor-pointer hover:border-accent hover:-translate-y-1 transition-all">
                <div class="w-16 h-16 bg-background rounded-full flex items-center justify-center mx-auto mb-4 border border-secondary group-hover:bg-accent/10 group-hover:text-accent transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                </div>
                <h4 class="text-lg font-bold text-foreground">Proposta Guiada por IA</h4>
                <p class="text-sm text-label mt-2">Responda a algumas perguntas e deixe o Copilot montar uma cesta de investimentos completa para você.</p>
            </div>
            <!-- Card 2: Solicitação Direta -->
            <div (click)="setCreationPath('direct')" class="group bg-secondary-light p-8 rounded-lg border border-secondary text-center cursor-pointer hover:border-accent hover:-translate-y-1 transition-all">
                <div class="w-16 h-16 bg-background rounded-full flex items-center justify-center mx-auto mb-4 border border-secondary group-hover:bg-accent/10 group-hover:text-accent transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                </div>
                <h4 class="text-lg font-bold text-foreground">Solicitação Direta de Ativos</h4>
                <p class="text-sm text-label mt-2">Selecione ativos manualmente da nossa lista completa, com o auxílio e sugestões do Copilot.</p>
            </div>
        </div>
    </div>
  } @else {
    <!-- Stepper -->
    <div class="flex-shrink-0 mb-6 border-b border-secondary">
      <div class="flex items-center max-w-lg mx-auto pb-4">
        @for (step of [{id: 1, name: 'Cliente'}, {id: 2, name: 'Selecione o Ativo'}, {id: 3, name: 'Confirmar Ordem'}]; track step.id; let i = $index) {
          <div class="flex items-center" [class]="{'flex-1': i < 2}">
            <div class="flex flex-col items-center text-center">
              <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold"
                   [class]="copilotStep() > step.id ? 'bg-status-success text-white' : (copilotStep() === step.id ? 'bg-foreground text-background' : 'bg-secondary text-label')">
                @if (copilotStep() > step.id) {
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                } @else {
                    {{ step.id }}
                }
              </div>
              <p class="mt-2 text-xs" [class]="copilotStep() >= step.id ? 'text-foreground font-semibold' : 'text-label'">{{ step.name }}</p>
            </div>
            @if (i < 2) {
              <div class="flex-1 h-0.5 mx-4" [class]="copilotStep() > step.id ? 'bg-status-success' : 'bg-secondary'"></div>
            }
          </div>
        }
      </div>
    </div>
    
    <div class="flex-grow grid grid-cols-1 lg:grid-cols-5 gap-8 min-h-0">
      <!-- Left Panel: Operations Desk -->
      <div class="lg:col-span-3 flex flex-col min-h-0">
          @if (copilotStep() === 1) {
            <div class="flex-grow flex flex-col items-center justify-center text-center">
              <h3 class="text-xl font-bold text-foreground mb-2">Selecione um cliente para começar</h3>
              <p class="text-label mb-4">Busque pelo nome do cliente para carregar suas informações.</p>
              <div class="relative w-full max-w-md">
                <input type="text" placeholder="Buscar cliente..." class="w-full p-3 pl-10 border border-secondary rounded-lg focus:ring-2 focus:ring-accent focus:border-accent" [value]="clientSearchTerm()" (input)="clientSearchTerm.set($any($event.target).value)">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-label" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                @if (filteredClients().length > 0) {
                  <ul class="absolute z-10 w-full bg-secondary-light border border-secondary rounded-lg mt-2 shadow-lg max-h-60 overflow-y-auto text-left">
                    @for (client of filteredClients(); track client.account) {
                      <li (click)="selectClient(client)" class="px-4 py-3 hover:bg-secondary cursor-pointer transition-colors">
                        <p class="font-medium text-foreground">{{ client.name }}</p>
                        <p class="text-sm text-label">Conta: {{ client.account }}</p>
                      </li>
                    }
                  </ul>
                }
              </div>
            </div>
          } @else {
            <div class="flex flex-col min-h-0">
                <!-- Client Info Card -->
                <div class="flex-shrink-0 bg-secondary-light p-4 rounded-lg border border-secondary mb-4">
                  <div class="flex justify-between items-start">
                    <div class="flex items-center gap-4">
                      <div class="w-16 h-16 rounded-full bg-secondary flex items-center justify-center font-bold text-xl text-foreground shrink-0">
                        {{ selectedClientInitials() }}
                      </div>
                      <div>
                        <h4 class="font-bold text-xl text-foreground">{{ selectedClient()?.name }}</h4>
                        <p class="text-sm text-label">ID: {{ selectedClient()?.account }}</p>
                      </div>
                    </div>
                    <button (click)="resetClientSelection()" class="text-sm text-label hover:text-foreground underline">Trocar</button>
                  </div>
                  <div class="mt-4 pt-4 border-t border-secondary text-sm grid grid-cols-3 gap-4">
                    <div>
                      <span class="text-label">Perfil de Risco:</span><br>
                      <span class="font-medium text-base px-2 py-0.5 rounded-md" [class]="getRiskBadgeClass(selectedClient()?.riskProfile)">
                        {{ selectedClient()?.riskProfile }}
                      </span>
                    </div>
                    <div>
                      <span class="text-label">Saldo em Conta:</span><br>
                      <span class="font-medium text-foreground text-base">{{ selectedClient()?.balance?.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) }}</span>
                    </div>
                    <div>
                      <span class="text-label">Patrimônio Total:</span><br>
                      <span class="font-medium text-foreground text-base">{{ selectedClient()?.patrimonioTotal?.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) }}</span>
                    </div>
                  </div>
                </div>

                @if (copilotStep() === 2) {
                   <!-- Asset Selection Area -->
                   <div class="flex-grow space-y-4 overflow-y-auto pr-2">
                       <!-- Recommended Assets -->
                       @if (recommendedAssets().length > 0) {
                        <div>
                           <h4 class="font-bold text-foreground mb-2">Ativos Recomendados pelo Copilot</h4>
                           <div class="space-y-3">
                                @for(asset of recommendedAssets(); track asset.id) {
                                    @let isSelected = isAssetSelected()(asset.id);
                                    <div class="bg-secondary-light p-3 rounded-lg border transition-colors" [class]="isSelected ? 'border-accent' : 'border-secondary'">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-semibold">{{asset.name}}</p>
                                                 <div class="text-xs text-label flex items-center flex-wrap gap-x-3 gap-y-1 mt-1">
                                                    <span><strong>Emissor:</strong> {{ asset.issuer }}</span>
                                                    <span><strong>Taxa:</strong> {{ asset.rate }}</span>
                                                    <span><strong>Risco:</strong> <span class="font-medium px-1.5 py-0.5 rounded" [class]="getRiskBadgeClass(asset.risk)">{{ asset.risk }}</span></span>
                                                    <span><strong>Venc.:</strong> {{ asset.expiry || 'N/A' }}</span>
                                                    <span><strong>Mín.:</strong> {{ asset.minAmount.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) }}</span>
                                                </div>
                                            </div>
                                            <button (click)="isSelected ? removeAssetFromOrder(asset.id) : selectAsset(asset)" class="px-3 py-1 text-sm font-medium rounded-md transition-colors ml-2" [class]="isSelected ? 'bg-status-error/20 text-status-error hover:bg-status-error/30' : 'bg-accent text-white hover:brightness-95'">
                                                {{ isSelected ? 'Remover' : 'Selecionar' }}
                                            </button>
                                        </div>
                                        @if(isSelected) {
                                            <div class="mt-2 pt-2 border-t border-secondary flex items-center gap-2">
                                                <label class="text-sm font-medium text-label">Valor:</label>
                                                <input type="number" [value]="getAmountForAsset(asset.id)" (input)="updateAmount(asset.id, $event)" [min]="asset.minAmount" class="w-full bg-background border border-secondary rounded p-1 text-sm focus:ring-accent focus:border-accent">
                                            </div>
                                        }
                                    </div>
                                }
                           </div>
                        </div>
                       }
                       <!-- Full Asset List -->
                        <div>
                            <button (click)="isFullAssetListOpen.set(!isFullAssetListOpen())" class="font-bold text-foreground mb-2 w-full text-left flex justify-between items-center">
                                <span>Lista Completa de Ativos</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="transition-transform" [class]="isFullAssetListOpen() ? 'rotate-180' : ''"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                            @if(isFullAssetListOpen()) {
                                <div class="border-b border-secondary mb-3">
                                  <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                    <button (click)="activeAssetTab.set('Pública')"
                                      class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
                                      [class]="activeAssetTab() === 'Pública' ? 'border-accent text-foreground' : 'border-transparent text-label hover:text-foreground hover:border-gray-300'">
                                      Ofertas Públicas
                                    </button>
                                    <button (click)="activeAssetTab.set('Privada')"
                                      class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
                                      [class]="activeAssetTab() === 'Privada' ? 'border-accent text-foreground' : 'border-transparent text-label hover:text-foreground hover:border-gray-300'">
                                      Ofertas Privadas
                                    </button>
                                  </nav>
                                </div>
                                @if (activeAssetTab() === 'Pública') {
                                    <div class="space-y-3">
                                        @for(asset of publicAssets(); track asset.id) {
                                            @let isSelected = isAssetSelected()(asset.id);
                                            <div class="bg-secondary-light p-3 rounded-lg border transition-colors" [class]="isSelected ? 'border-accent' : 'border-secondary'">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-semibold">{{asset.name}}</p>
                                                        <div class="text-xs text-label flex items-center flex-wrap gap-x-3 gap-y-1 mt-1">
                                                            <span><strong>Emissor:</strong> {{ asset.issuer }}</span>
                                                            <span><strong>Taxa:</strong> {{ asset.rate }}</span>
                                                            <span><strong>Risco:</strong> <span class="font-medium px-1.5 py-0.5 rounded" [class]="getRiskBadgeClass(asset.risk)">{{ asset.risk }}</span></span>
                                                            <span><strong>Venc.:</strong> {{ asset.expiry || 'N/A' }}</span>
                                                            <span><strong>Mín.:</strong> {{ asset.minAmount.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) }}</span>
                                                        </div>
                                                    </div>
                                                    <button (click)="isSelected ? removeAssetFromOrder(asset.id) : selectAsset(asset)" class="px-3 py-1 text-sm font-medium rounded-md transition-colors ml-2" [class]="isSelected ? 'bg-status-error/20 text-status-error hover:bg-status-error/30' : 'bg-accent text-white hover:brightness-95'">
                                                        {{ isSelected ? 'Remover' : 'Selecionar' }}
                                                    </button>
                                                </div>
                                                @if(isSelected) {
                                                    <div class="mt-2 pt-2 border-t border-secondary flex items-center gap-2">
                                                        <label class="text-sm font-medium text-label">Valor:</label>
                                                        <input type="number" [value]="getAmountForAsset(asset.id)" (input)="updateAmount(asset.id, $event)" [min]="asset.minAmount" class="w-full bg-background border border-secondary rounded p-1 text-sm focus:ring-accent focus:border-accent">
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                @if (activeAssetTab() === 'Privada') {
                                    <div class="space-y-3">
                                        @for(asset of privateAssets(); track asset.id) {
                                            @let isSelected = isAssetSelected()(asset.id);
                                            <div class="bg-secondary-light p-3 rounded-lg border transition-colors" [class]="isSelected ? 'border-accent' : 'border-secondary'">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-semibold">{{asset.name}}</p>
                                                        <div class="text-xs text-label flex items-center flex-wrap gap-x-3 gap-y-1 mt-1">
                                                            <span><strong>Emissor:</strong> {{ asset.issuer }}</span>
                                                            <span><strong>Taxa:</strong> {{ asset.rate }}</span>
                                                            <span><strong>Risco:</strong> <span class="font-medium px-1.5 py-0.5 rounded" [class]="getRiskBadgeClass(asset.risk)">{{ asset.risk }}</span></span>
                                                            <span><strong>Venc.:</strong> {{ asset.expiry || 'N/A' }}</span>
                                                            <span><strong>Mín.:</strong> {{ asset.minAmount.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) }}</span>
                                                        </div>
                                                    </div>
                                                    <button (click)="isSelected ? removeAssetFromOrder(asset.id) : selectAsset(asset)" class="px-3 py-1 text-sm font-medium rounded-md transition-colors ml-2" [class]="isSelected ? 'bg-status-error/20 text-status-error hover:bg-status-error/30' : 'bg-accent text-white hover:brightness-95'">
                                                        {{ isSelected ? 'Remover' : 'Selecionar' }}
                                                    </button>
                                                </div>
                                                @if(isSelected) {
                                                    <div class="mt-2 pt-2 border-t border-secondary flex items-center gap-2">
                                                        <label class="text-sm font-medium text-label">Valor:</label>
                                                        <input type="number" [value]="getAmountForAsset(asset.id)" (input)="updateAmount(asset.id, $event)" [min]="asset.minAmount" class="w-full bg-background border border-secondary rounded p-1 text-sm focus:ring-accent focus:border-accent">
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                   </div>
                } @else if (copilotStep() === 3) {
                    <!-- Confirmation View -->
                    <div class="flex-grow space-y-4 overflow-y-auto pr-2">
                        <h3 class="text-xl font-bold text-foreground">Revisar e Confirmar Ordem</h3>
                        <div class="bg-secondary-light p-4 rounded-lg border border-secondary">
                            <h4 class="font-bold mb-3">Cesta Final</h4>
                             @for(item of currentOrderItems(); track item.asset.id) {
                                <div class="flex justify-between items-center py-2 border-b border-secondary last:border-b-0">
                                  <span class="text-sm font-medium">{{ item.asset.name }}</span>
                                  <span class="text-sm text-foreground font-semibold">{{ item.amount.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) }}</span>
                                </div>
                              }
                            <div class="mt-3 pt-3 border-t-2 border-secondary font-bold flex justify-between text-lg">
                                <span>Total:</span>
                                <span>{{ totalOrderValue().toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) }}</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        <!-- Footer Navigation -->
        @if (selectedClient() && copilotStep() > 1) {
            <div class="flex-shrink-0 mt-6 pt-6 border-t border-secondary flex justify-between items-center">
                <button (click)="prevStep()" class="px-4 py-2 bg-secondary-light border border-secondary text-foreground text-sm font-medium rounded-md hover:bg-secondary transition-colors">
                    Voltar
                </button>
                @if (copilotStep() === 2) {
                    <button (click)="nextStep()" [disabled]="currentOrderItems().length === 0" class="px-4 py-2 bg-foreground text-background text-sm font-medium rounded-md hover:brightness-95 active:brightness-90 transition-all disabled:opacity-50">
                        Revisar e Finalizar Ordem
                    </button>
                } @else {
                     <button (click)="createOrder()" class="px-4 py-2 bg-accent text-white font-bold rounded-md hover:brightness-95 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                        Criar Ordem
                    </button>
                }
            </div>
        }
      </div>

      <!-- Right Panel: Copilot Chat -->
      <div class="lg:col-span-2 bg-secondary-light rounded-lg border border-secondary flex flex-col max-h-[80vh]">
        <!-- Chat Header -->
        <div class="flex-shrink-0 p-3 border-b border-secondary flex justify-between items-center">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-400 to-red-500 flex items-center justify-center text-white">
               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a4.5 4.5 0 0 0-4.5 4.5c0 1.25.5 2.4 1.34 3.25 C7.9 10.68 7 11.75 7 13c0 1.66 1.34 3 3 3h1.34c.34 0 .66.17.84.44.18.27.22.62.1.94-.12.32-.38.52-.7.52H10"/>
                <path d="M12 2a4.5 4.5 0 0 1 4.5 4.5c0 1.25-.5 2.4-1.34 3.25 C16.1 10.68 17 11.75 17 13c0 1.66-1.34 3-3 3h-1.34c-.34 0-.66.17-.84.44-.18.27-.22.62-.1.94.12.32.38.52.7.52H14"/>
                <path d="M12 16v2.5a2.5 2.5 0 0 0 2.5 2.5h0a2.5 2.5 0 0 0 2.5-2.5V18"/>
                <path d="M12 16v2.5a2.5 2.5 0 0 1-2.5 2.5h0a2.5 2.5 0 0 1-2.5-2.5V18"/>
                <path d="M12 2v14"/>
               </svg>
            </div>
            <h3 class="font-bold text-lg">Copilot</h3>
          </div>
          <div class="text-right">
            <p class="text-xs text-label">Resumo da Ordem</p>
            <p class="text-sm font-bold">{{ currentOrderItems().length }} Ativos | {{ totalOrderValue() | number:'1.2-2' }}</p>
          </div>
        </div>
        <!-- Chat Messages -->
        <div class="flex-grow p-4 space-y-4 overflow-y-auto">
          @for (message of chatMessages(); track $index; let i = $index) {
            @if(message.sender === 'user') {
              <div class="flex justify-end">
                <div class="bg-foreground text-background p-3 rounded-lg max-w-lg">
                  {{ message.text }}
                </div>
              </div>
            } @else if(message.sender === 'ai') {
              <div class="flex justify-start gap-2">
                 <div class="w-8 h-8 rounded-full bg-secondary flex items-center justify-center text-foreground shrink-0 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                 </div>
                <div class="bg-secondary p-3 rounded-lg max-w-lg">
                  <p class="whitespace-pre-wrap">{{ message.text }}</p>
                </div>
                <button (click)="speak(message.text, i)" class="self-center p-2 text-label hover:text-foreground hover:bg-background rounded-full transition-colors">
                    @if (isSpeaking() && speakingMessageIndex() === i) {
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></svg>
                    } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    }
                </button>
              </div>
            } @else {
               <div class="text-center text-sm text-status-error">{{ message.text }}</div>
            }
          }
          @if (isThinking()) {
            <div class="flex justify-start">
                <div class="bg-secondary p-3 rounded-lg max-w-lg flex items-center gap-2">
                   <div class="w-2 h-2 bg-foreground rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                   <div class="w-2 h-2 bg-foreground rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                   <div class="w-2 h-2 bg-foreground rounded-full animate-bounce"></div>
                </div>
            </div>
          }
        </div>
        <!-- Chat Input -->
        <div class="flex-shrink-0 p-3 border-t border-secondary">
          <div class="flex items-center gap-2 relative">
            <textarea 
              rows="1"
              class="w-full p-2 pr-20 bg-background border border-secondary rounded-lg resize-none focus:ring-2 focus:ring-accent"
              placeholder="Digite sua solicitação ou use o microfone..."
              [value]="userMessage()"
              (input)="userMessage.set($any($event.target).value)"
              (keydown.enter)="$event.preventDefault(); sendMessage()"
            ></textarea>
            <div class="absolute right-2 flex items-center">
              <button 
                (click)="toggleRecording()"
                [disabled]="isTranscribing() || !selectedClient()"
                class="p-2 rounded-full transition-colors duration-200 w-9 h-9 flex items-center justify-center"
                [class]="isRecording() ? 'bg-status-error/10 text-status-error animate-pulse-red' : 'hover:bg-secondary text-label'">
                @if (isTranscribing()) {
                  <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                } @else {
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
                }
              </button>
              <button 
                (click)="sendMessage()" 
                [disabled]="!userMessage() || isThinking() || !selectedClient()"
                class="p-2 bg-accent text-white rounded-full disabled:opacity-50 hover:brightness-95 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</div>
<style>
  @keyframes pulse-red {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
    }
  }
  .animate-pulse-red {
    animation: pulse-red 1.5s infinite;
  }
</style>